name: Daily Fly.io Backups

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual backup'
        required: false
        default: 'Manual backup triggered'

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  backup-volumes:
    name: Backup ${{ matrix.volume_name }} Volume
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - app: trevecca-pedia-wiki
            volume_name: wiki_data
          - app: trevecca-pedia-search
            volume_name: search_index

    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get volume ID
        id: get-volume
        run: |
          echo "ðŸ” Looking up volume ID for ${{ matrix.volume_name }}..."
          VOLUME_ID=$(fly volumes list --app ${{ matrix.app }} --json | \
            jq -r '.[] | select(.name == "${{ matrix.volume_name }}") | .id')
          
          if [ -z "$VOLUME_ID" ]; then
            echo "âŒ Volume '${{ matrix.volume_name }}' not found!"
            exit 1
          fi
          
          echo "volume_id=$VOLUME_ID" >> $GITHUB_OUTPUT
          echo "âœ… Using volume ID: $VOLUME_ID"

      - name: Create snapshot
        run: |
          echo "ðŸ“¸ Creating snapshot for ${{ matrix.volume_name }}..."
          fly volumes snapshots create ${{ steps.get-volume.outputs.volume_id }} \
            --app ${{ matrix.app }} --yes
          echo "âœ… Snapshot created"

      - name: Cleanup old snapshots (keep 30)
        run: |
          echo "ðŸ§¹ Cleaning up old snapshots (keeping 30 newest)..."
          fly volumes snapshots list ${{ steps.get-volume.outputs.volume_id }} \
            --app ${{ matrix.app }} --json | \
            jq -r '.[30:][]?.id' | \
            while read -r snapshot_id; do
              if [ -n "$snapshot_id" ]; then
                echo "ðŸ—‘ï¸ Deleting old snapshot: $snapshot_id"
                fly volumes snapshots delete "$snapshot_id" \
                  --app ${{ matrix.app }} --yes || true
              fi
            done
          echo "âœ… Cleanup complete"

      - name: Verify snapshots
        run: |
          echo "ðŸ“‹ Current snapshots:"
          fly volumes snapshots list ${{ steps.get-volume.outputs.volume_id }} --app ${{ matrix.app }}

  backup-database:
    name: Backup PostgreSQL Database
    runs-on: ubuntu-latest
    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create database backup (via SSH â€” no password secret needed)
        id: db-backup
        run: |
          echo "ðŸš€ Running pg_dump inside the Postgres VM..."
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_FILE="trevecca-pedia-wiki-${TIMESTAMP}.dump"

          fly ssh console -a trevecca-pedia-db --command '
            pg_dump -U postgres -d wiki \
              --clean --if-exists --no-owner --no-acl -Fc
          ' > "$BACKUP_FILE"

          echo "âœ… Backup created: $BACKUP_FILE ($(du -h "$BACKUP_FILE" | cut -f1))"
          echo "backup_path=$BACKUP_FILE" >> $GITHUB_OUTPUT

      - name: Upload database backup (GitHub Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: database-backup
          path: ${{ steps.db-backup.outputs.backup_path }}
          retention-days: 30
          if-no-files-found: error

  notify-on-failure:
    name: Notify on Failure
    needs: [backup-volumes, backup-database]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create GitHub Issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = 'ðŸš¨ Daily Backup Failed';
            const runUrl = context.payload.repository.html_url + '/actions/runs/' + context.runId;
            
            const volumesStatus = '${{ needs.backup-volumes.result }}' === 'failure' ? 'âŒ' : 'âœ…';
            const dbStatus = '${{ needs.backup-database.result }}' === 'failure' ? 'âŒ' : 'âœ…';
            
            const issueBody = [
              '## Backup Failure Alert',
              '',
              'The daily backup workflow failed for **Trevecca Pedia**.',
              '',
              '| Detail | Value |',
              '|--------|-------|',
              '| Repository | ' + context.repo.owner + '/' + context.repo.repo + ' |',
              '| Workflow | ' + context.workflow + ' |',
              '| Run ID | ' + context.runId + ' |',
              '| Time | ' + new Date().toISOString() + ' |',
              '',
              '### Failed Jobs',
              '- ' + volumesStatus + ' Volume backups (Wiki + Search)',
              '- ' + dbStatus + ' Database backup',
              '',
              '### Next Steps',
              '1. [View the failed run](' + runUrl + ')',
              '2. Check the logs for error details',
              '',
              '---',
              '*This issue was automatically created by the backup workflow.*'
            ].join('\n');

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'backup-failure'
            });

            const existingIssue = issues.data.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              const commentBody = 'Backup failed again on ' + new Date().toISOString() + '\n\n[View run](' + runUrl + ')';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: commentBody
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['backup-failure', 'automated']
              });
            }
